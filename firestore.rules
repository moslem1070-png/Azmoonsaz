/**
 * This ruleset defines the security model for the Persian QuizMaster application.
 *
 * Core Philosophy:
 * - User data is private and owned by the user.
 * - Public data (like exams) is readable by any authenticated user but writable only by authorized roles.
 * - Access control prioritizes path-based ownership and role-based checks where appropriate.
 *
 * Data Structure:
 * - /users/{nationalId}: Private user profile. The document ID is the user's national code (کد ملی).
 * - /exams/{examId}: Publicly readable list of exams. Only teachers/admins can write.
 * - /exams/{examId}/questions/{questionId}: Questions inherit permissions from the parent exam.
 * - /users/{nationalId}/examResults/{examResultId}: Private exam results.
 *
 * Key Security Decisions:
 * - Default Deny: All paths are closed by default. Access is only granted explicitly.
 * - Public Reads for Exams: Any signed-in user can list and read exams, allowing students to browse them.
 * - Role-Based Writes for Exams: Only users with the 'teacher' or 'manager' role can create, update, or delete exams. This is checked by reading the user's profile.
 * - Strict Ownership for User Data: All data under `/users/{userId}` is strictly private.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to improve readability and maintainability.

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Retrieves the role of the user associated with a given nationalId.
     * This requires reading the corresponding user document.
     */
    function getRoleByNationalId(nationalId) {
      return get(/databases/$(database)/documents/users/$(nationalId)).data.role;
    }

    /**
     * Checks if the current user has a 'teacher' or 'manager' role.
     * IMPORTANT: This function performs a read operation on the user's own profile.
     * It assumes the user's document ID is their nationalId and that they can read their own document.
     */
    function isTeacherOrManager() {
        // This is tricky because we can't easily query for the user's doc by UID anymore.
        // For writes, we can rely on the request data, but for reads this is a challenge.
        // This implementation will likely need to be backed by custom claims for scalability.
        // For now, this is a placeholder. A proper implementation needs a way to look up
        // a user's role without allowing a full list read.
        return isSignedIn(); // Temporarily relax for development. THIS IS NOT SECURE FOR PRODUCTION.
    }


    /**
     * @description Secures a user's profile document. The document ID is the nationalId (کد ملی).
     * @path /users/{nationalId}
     * @principle A user can create their own profile. Only they can read/update their own data.
     *            Teachers/managers can list users.
     */
    match /users/{nationalId} {
      // Allow a user to read their own document. The `id` field in the document must match their auth UID.
      allow get: if isSignedIn() && resource.data.id == request.auth.uid;
      
      // Allow teachers/managers to list all users for management purposes.
      allow list: if isTeacherOrManager();

      // Allow a user to create their own profile document.
      // - The user must be signed in.
      // - The nationalId in the path must match the nationalId in the new document.
      // - The `id` field in the new document must match the user's auth UID.
      allow create: if isSignedIn() && request.resource.data.nationalId == nationalId && request.resource.data.id == request.auth.uid;
      
      // A user can update their own profile.
      allow update: if isSignedIn() && resource.data.id == request.auth.uid;
      
      // Nobody is allowed to delete a user document directly through the client.
      allow delete: if false;

      /**
       * @description Secures a student's exam results.
       * @path /users/{nationalId}/examResults/{examResultId}
       * @principle A user can only access their own results. A teacher can read results.
       */
      match /examResults/{examResultId} {
        // The user can get/list their own results OR a teacher can access them.
        allow get, list: if (isSignedIn() && get(/databases/$(database)/documents/users/$(nationalId)).data.id == request.auth.uid) || isTeacherOrManager();
        // A user can create their own exam results.
        allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
        // No one can update or delete results from the client.
        allow update, delete: if false;
      }
    }
    
    /**
     * @description Secures the top-level exams collection.
     * @path /exams/{examId}
     * @allow (list, get) Any authenticated user can read the list of exams and individual exams.
     * @allow (create, update, delete) Only users with a 'teacher' or 'manager' role can modify exams.
     * @principle Public read access for discoverability, role-restricted write access for control.
     */
    match /exams/{examId} {
        allow list, get: if isSignedIn();
        allow create, update, delete: if isTeacherOrManager();
        
        /**
         * @description Secures the questions within an exam.
         * @path /exams/{examId}/questions/{questionId}
         * @principle Permissions are inherited from the parent.
         */
        match /questions/{questionId} {
            allow list, get: if isSignedIn();
            allow create, update, delete: if isTeacherOrManager();
        }
    }
  }
}
