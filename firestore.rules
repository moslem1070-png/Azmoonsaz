/**
 * This ruleset defines the security model for the Persian QuizMaster application.
 *
 * Core Philosophy:
 * - User data is private and owned by the user.
 * - Public data (like exams) is readable by any authenticated user but writable only by authorized roles.
 * - Access control prioritizes path-based ownership and role-based checks where appropriate.
 *
 * Data Structure:
 * - /users/{userId}: Private user profile. Only the user can read/write their own profile.
 * - /exams/{examId}: Publicly readable list of exams. Only teachers/admins can write.
 * - /exams/{examId}/questions/{questionId}: Questions inherit permissions from the parent exam.
 * - /users/{userId}/examResults/{examResultId}: Private exam results. Only the student can read/write their own results.
 *
 * Key Security Decisions:
 * - Default Deny: All paths are closed by default. Access is only granted explicitly.
 * - Public Reads for Exams: Any signed-in user can list and read exams, allowing students to browse them.
 * - Role-Based Writes for Exams: Only users with the 'teacher' or 'manager' role can create, update, or delete exams. This is checked by reading the user's profile.
 * - Strict Ownership for User Data: All data under `/users/{userId}` is strictly private.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to improve readability and maintainability.

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * This is the primary function for enforcing path-based ownership.
     * @param userId The user ID from the document path.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks for ownership on an existing document. Used for update and delete
     * operations to prevent acting on non-existent data.
     * @param userId The user ID from the document path.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Retrieves the role of the currently authenticated user from their profile document.
     * Returns null if the user is not signed in or their profile doesn't exist.
     */
    function getUserRole() {
      let uid = request.auth.uid;
      if (uid == null) {
        return null;
      }
      // get() is a cross-document read, which has security and performance implications.
      // Use it judiciously, primarily for role-based checks on non-user-owned data.
      return get(/databases/$(database)/documents/users/$(uid)).data.role;
    }

    /**
     * Checks if the current user has a 'teacher' or 'manager' role.
     */
    function isTeacherOrManager() {
        let role = getUserRole();
        return role == 'teacher' || role == 'manager';
    }


    /**
     * @description Secures a user's profile document. Users can create their own profile,
     *   and only they can read, update, or delete it. Listing all users is forbidden unless the user is a manager.
     * @path /users/{userId}
     * @allow (get) User 'user-abc' reading their own profile at `/users/user-abc`.
     * @allow (list) A user with the 'manager' role listing all users.
     * @deny (get) User 'user-abc' trying to read the profile document at `/users/user-xyz`.
     * @principle Enforces Self-Creation and strict Ownership for user profiles, with an exception for managers.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if isTeacherOrManager(); // Allow managers/teachers to list users
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);

      /**
       * @description Secures a student's exam results. A student can create their own results
       *   and can read them, but cannot modify or delete them to ensure data integrity.
       * @path /users/{userId}/examResults/{examResultId}
       * @allow (create) Student 'student-456' submitting their result to `/users/student-456/examResults/res-abc`.
       * @deny (update) Student 'student-456' trying to change their score after submission.
       * @principle Enforces ownership for creation and reads, but makes results immutable after creation.
       */
      match /examResults/{examResultId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.studentId == userId;
        allow update: if false;
        allow delete: if false;
      }
    }
    
    /**
     * @description Secures the top-level exams collection.
     * @path /exams/{examId}
     * @allow (list, get) Any authenticated user can read the list of exams and individual exams.
     * @allow (create, update, delete) Only users with a 'teacher' or 'manager' role can modify exams.
     * @principle Public read access for discoverability, role-restricted write access for control.
     */
    match /exams/{examId} {
        allow list, get: if isSignedIn();
        allow create, update, delete: if isTeacherOrManager();
        
        /**
         * @description Secures the questions within an exam. Access is inherited from the
         *   parent user (teacher) path, ensuring only the exam creator can manage its questions.
         * @path /exams/{examId}/questions/{questionId}
         * @principle Inherits ownership from the top-level path for nested subcollections.
         */
        match /questions/{questionId} {
            allow list, get: if isSignedIn();
            allow create, update, delete: if isTeacherOrManager();
        }
    }
  }
}
