/**
 * This ruleset defines the security model for the Persian QuizMaster application.
 *
 * Core Philosophy:
 * - User data is private and owned by the user.
 * - Public data (like exams) is readable by any authenticated user but writable only by authorized roles.
 * - Access control prioritizes path-based ownership and role-based checks where appropriate.
 *
 * Data Structure:
 * - /users/{nationalId}: Private user profile. The document ID is the user's national code.
 * - /exams/{examId}: Publicly readable list of exams. Only teachers/admins can write.
 * - /exams/{examId}/questions/{questionId}: Questions inherit permissions from the parent exam.
 * - /users/{nationalId}/examResults/{examResultId}: Private exam results.
 *
 * Key Security Decisions:
 * - Default Deny: All paths are closed by default. Access is only granted explicitly.
 * - Public Reads for Exams: Any signed-in user can list and read exams, allowing students to browse them.
 * - Role-Based Writes for Exams: Only users with the 'teacher' or 'manager' role can create, update, or delete exams. This is checked by reading the user's profile.
 * - Strict Ownership for User Data: All data under `/users/{userId}` is strictly private.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to improve readability and maintainability.

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * This is the primary function for enforcing path-based ownership.
     * @param userId The user ID from the document path.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * Checks if the user's nationalId (from their own profile) matches the document ID.
     * This enforces ownership when document ID is the nationalId.
     */
    function isOwnerByNationalId(nationalId) {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.nationalId == nationalId;
    }

    /**
     * Checks for ownership on an existing document. Used for update and delete
     * operations to prevent acting on non-existent data.
     * @param userId The user ID from the document path.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Retrieves the role of the currently authenticated user from their profile document.
     * Returns null if the user is not signed in or their profile doesn't exist.
     */
    function getUserRole() {
      let uid = request.auth.uid;
      if (uid == null) {
        return null;
      }
      // Since user documents are now keyed by nationalId, we cannot directly get() them with UID.
      // This is a major change. We need a way to get the user's role.
      // For now, we will assume a user can read their own document to check their role.
      // A better long-term solution might be custom claims.
      let userDocId = request.auth.token.email.split('@')[0].substring(8); // extracts nationalId from student-nationalId@...
      if (request.auth.token.email.startsWith('teacher-')) {
          userDocId = request.auth.token.email.split('@')[0].substring(8); // extracts username from teacher-username@...
      }
      return get(/databases/$(database)/documents/users/$(userDocId)).data.role;
    }

    /**
     * Checks if the current user has a 'teacher' or 'manager' role.
     */
    function isTeacherOrManager() {
        let role = getUserRole();
        return role == 'teacher' || role == 'manager';
    }


    /**
     * @description Secures a user's profile document. The document ID is now the nationalId.
     * @path /users/{nationalId}
     * @principle Users can create their own profile. Only they can read/update their own data.
     */
    match /users/{nationalId} {
      // A user can read their own profile. We must now verify based on the content of the document.
      allow get: if isSignedIn() && resource.data.id == request.auth.uid;
      allow list: if isTeacherOrManager(); // Allow managers/teachers to list users

      // A user can create their profile if the document ID (nationalId) matches the nationalId in the resource
      // AND the auth UID matches the id field in the resource.
      allow create: if isSignedIn() && request.resource.id == nationalId && request.resource.data.id == request.auth.uid;
      
      // A user can update their own profile.
      allow update: if isSignedIn() && resource.data.id == request.auth.uid;
      
      allow delete: if false; // Generally, users should not delete their own profiles.

      /**
       * @description Secures a student's exam results.
       * @path /users/{nationalId}/examResults/{examResultId}
       * @principle A user can only access their own results.
       */
      match /examResults/{examResultId} {
        allow get, list: if isSignedIn() && get(/databases/$(database)/documents/users/$(nationalId)).data.id == request.auth.uid;
        allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
        allow update, delete: if false;
      }
    }
    
    /**
     * @description Secures the top-level exams collection.
     * @path /exams/{examId}
     * @allow (list, get) Any authenticated user can read the list of exams and individual exams.
     * @allow (create, update, delete) Only users with a 'teacher' or 'manager' role can modify exams.
     * @principle Public read access for discoverability, role-restricted write access for control.
     */
    match /exams/{examId} {
        allow list, get: if isSignedIn();
        allow create, update, delete: if isTeacherOrManager();
        
        /**
         * @description Secures the questions within an exam.
         * @path /exams/{examId}/questions/{questionId}
         * @principle Permissions are inherited from the parent.
         */
        match /questions/{questionId} {
            allow list, get: if isSignedIn();
            allow create, update, delete: if isTeacherOrManager();
        }
    }
  }
}
