/**
 * This ruleset defines the security model for the Persian QuizMaster application.
 *
 * Core Philosophy:
 * - User data is private and owned by the user.
 * - Public data (like exams) is readable by any authenticated user but writable only by authorized roles.
 * - Access control prioritizes path-based ownership and role-based checks where appropriate.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to improve readability and maintainability.

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }
    
    /**
     * Checks if the currently authenticated user's role is 'teacher'.
     * This function reads the user's own profile document.
     */
    function isTeacher() {
      // It is assumed the user's document exists and the UID matches the document ID
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
    }


    /**
     * @description Secures a user's profile document.
     * @path /users/{userId}
     * @principle A user can create their own profile. Only they can read/update their own data.
     */
    match /users/{userId} {
      // A user can read/update their own profile document if their auth UID matches the 'id' field in the doc.
      allow read, update: if isSignedIn() && get(/databases/$(database)/documents/users/$(userId)).data.id == request.auth.uid;
      
      // Allow a signed-in user to create their own profile document during signup.
      // The document ID MUST match the nationalId from the resource data.
      // The 'id' field within the document must match the auth UID.
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.id && userId == request.resource.data.nationalId;
      
      // Nobody is allowed to delete a user document directly through the client.
      allow delete: if false;

      // Teachers can list all users for management purposes.
      allow list: if isTeacher();

      /**
       * @description Secures a student's exam results.
       * @path /users/{userId}/examResults/{examResultId}
       * @principle A user can only access their own results. A teacher can read results.
       */
      match /examResults/{examResultId} {
        // Allow access if the requesting user's UID matches the 'id' field in the parent user document, OR if the user is a teacher.
        allow get, list: if (isSignedIn() && get(/databases/$(database)/documents/users/$(userId)).data.id == request.auth.uid) || isTeacher();
        
        // A user can create their own exam results.
        allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
        
        // No one can update or delete results from the client.
        allow update, delete: if false;
      }
    }
    
    /**
     * @description Secures the top-level exams collection and their questions.
     * @path /exams/{examId}
     * @principle Public read access for discoverability, role-restricted write access for control.
     */
    match /exams/{examId} {
        // Any authenticated user (student or teacher) can read exams and their questions.
        allow get, list: if isSignedIn();
        
        // A user can create an exam if they are a signed-in teacher.
        allow create: if isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher' && request.resource.data.teacherId == request.auth.uid;
        
        // A user can update or delete an exam if they are the teacher who created it.
        allow update, delete: if isSignedIn() && resource.data.teacherId == request.auth.uid;
        
        // This rule allows any authenticated user to also read the questions subcollection.
        match /questions/{questionId} {
            allow get, list: if isSignedIn();
             // Only the teacher who owns the exam can modify its questions.
            allow write: if isSignedIn() && get(/databases/$(database)/documents/exams/$(examId)).data.teacherId == request.auth.uid;
        }
    }
  }
}
