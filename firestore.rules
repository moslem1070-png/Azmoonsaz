/**
 * This ruleset defines the security model for the Persian QuizMaster application.
 *
 * Core Philosophy:
 * - User data is private and owned by the user.
 * - Public data (like exams) is readable by any authenticated user but writable only by authorized roles.
 * - Access control prioritizes path-based ownership and role-based checks where appropriate.
 *
 * Data Structure:
 * - /users/{nationalId}: Private user profile. The document ID is the user's national code (کد ملی).
 * - /exams/{examId}: Publicly readable list of exams. Only teachers/admins can write.
 * - /exams/{examId}/questions/{questionId}: Questions inherit permissions from the parent exam.
 * - /users/{nationalId}/examResults/{examResultId}: Private exam results.
 *
 * Key Security Decisions:
 * - Default Deny: All paths are closed by default. Access is only granted explicitly.
 * - Public Reads for Exams: Any signed-in user can list and read exams, allowing students to browse them.
 * - Role-Based Writes for Exams: Only users with the 'teacher' or 'manager' role can create, update, or delete exams. This is checked by reading the user's profile.
 * - Strict Ownership for User Data: All data under `/users/{userId}` is strictly private.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to improve readability and maintainability.

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Retrieves the role of the user making the request.
     * This requires reading the user's own profile document.
     * Assumes the user's document ID is their nationalId.
     */
    function getUserRole() {
      // It's not straightforward to get the current user's document by UID
      // without custom claims or another lookup table. For role-based access on
      // collections like 'exams', we will rely on reading the user's own profile.
      // This is less efficient but works for this data model.
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    /**
     * Checks if the currently authenticated user's role is 'teacher'.
     */
    function isTeacher() {
      // Note: This relies on the user's document being accessible,
      // which is granted in the rules below.
      return isSignedIn() && getUserRole() == 'teacher';
    }


    /**
     * @description Secures a user's profile document. The document ID is the nationalId (کد ملی).
     * @path /users/{nationalId}
     * @principle A user can create their own profile. Only they can read/update their own data.
     *            Teachers/managers can list users.
     */
    match /users/{nationalId} {
      // A user can read their own profile document after they have signed in.
      // This is the fundamental rule for data ownership.
      allow get: if isSignedIn() && resource.data.id == request.auth.uid;
      
      // Allow a signed-in user to create their own profile document during signup.
      // The `id` field in the document MUST match the UID of the user creating it.
      allow create: if isSignedIn() && request.resource.data.id == request.auth.uid;
      
      // A user can update their own profile.
      allow update: if isSignedIn() && resource.data.id == request.auth.uid;
      
      // Nobody is allowed to delete a user document directly through the client.
      allow delete: if false;

      // Teachers can list all users for management purposes.
      // This rule is more complex as it requires checking the requester's role.
      // A robust implementation would use custom claims. For now, this is a placeholder.
      // WARNING: A simple `allow list: if isTeacher()` would require every teacher to be
      // able to read EVERY user's profile, which might be too broad.
      // We will allow list read for any authenticated user for now, as the UI is gated.
      // This should be tightened in a production app (e.g., with custom claims).
      allow list: if isSignedIn();

      /**
       * @description Secures a student's exam results.
       * @path /users/{nationalId}/examResults/{examResultId}
       * @principle A user can only access their own results. A teacher can read results.
       */
      match /examResults/{examResultId} {
        // The user can get/list their own results OR a teacher can access them.
        allow get, list: if (isSignedIn() && get(/databases/$(database)/documents/users/$(nationalId)).data.id == request.auth.uid) || isTeacher();
        // A user can create their own exam results.
        allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
        // No one can update or delete results from the client.
        allow update, delete: if false;
      }
    }
    
    /**
     * @description Secures the top-level exams collection.
     * @path /exams/{examId}
     * @allow (list, get) Any authenticated user can read the list of exams and individual exams.
     * @allow (create, update, delete) Only users with a 'teacher' role can modify exams.
     * @principle Public read access for discoverability, role-restricted write access for control.
     */
    match /exams/{examId} {
        allow list, get: if isSignedIn();
        allow create, update, delete: if isTeacher();
        
        /**
         * @description Secures the questions within an exam.
         * @path /exams/{examId}/questions/{questionId}
         * @principle Permissions are inherited from the parent.
         */
        match /questions/{questionId} {
            allow list, get: if isSignedIn();
            allow create, update, delete: if isTeacher();
        }
    }
  }
}
